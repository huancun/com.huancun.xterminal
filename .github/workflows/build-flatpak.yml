# å·¥ä½œæµåç§°
name: Build and Release Flatpak

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  # å®šæ—¶ä»»åŠ¡è§¦å‘
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹ (UTC) è¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
    - cron: '0 2 * * *'
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      force_build:
        description: 'å¼ºåˆ¶æ„å»ºï¼Œå³ä½¿æ²¡æœ‰æ–°ç‰ˆæœ¬'
        required: false
        default: 'false'
        type: boolean

# ä¸ºå·¥ä½œæµä¸­æ‰€æœ‰ä½œä¸šè®¾ç½®é»˜è®¤æƒé™
permissions:
  contents: write # å…è®¸å‘ä»“åº“å†™å…¥å†…å®¹ï¼Œä¾‹å¦‚åˆ›å»ºRelease

# å®šä¹‰å·¥ä½œæµä¸­çš„ä½œä¸š
jobs:
  # ä½œä¸š1: æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬
  check-version:
    name: Check XTerminal Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag_name: ${{ steps.get-version.outputs.tag_name }}
      should_build: ${{ steps.check-build.outputs.should_build }}
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # æ­¥éª¤2: ä»APIè·å–æœ€æ–°çš„XTerminalç‰ˆæœ¬ä¿¡æ¯
    - name: Get latest XTerminal release
      id: get-version
      run: |
        echo "=== Fetching latest release from API ==="
        
        # ä»æŒ‡å®šAPIè·å–ç‰ˆæœ¬ä¿¡æ¯
        RELEASE_INFO=$(curl -s "https://api.xterminal.cn/server/electron/version3")
        
        echo "API Response:"
        echo "$RELEASE_INFO" | jq '.'
        
        # ä½¿ç”¨jqè§£æJSONï¼Œæå–Linuxç‰ˆæœ¬å·
        VERSION=$(echo "$RELEASE_INFO" | jq -r '.linux.version // empty')
        
        # å¦‚æœæ— æ³•è·å–ç‰ˆæœ¬å·ï¼Œåˆ™ä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬å¹¶é€€å‡º
        if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
          echo "Error: Failed to get version from API response"
          exit 1
        fi
        
        # æ ¹æ®ç‰ˆæœ¬å·æ„é€ tag_name
        TAG_NAME="v$VERSION"
        
        # å°†ç‰ˆæœ¬å·å’Œtag_nameè®¾ç½®ä¸ºstepçš„è¾“å‡º
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Latest XTerminal version: $VERSION (tag: $TAG_NAME)"
        
    # æ­¥éª¤3: æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»º
    - name: Check if build is needed
      id: check-build
      run: |
        VERSION="${{ steps.get-version.outputs.version }}"
        FORCE_BUILD="${{ github.event.inputs.force_build }}"
        
        echo "Checking if build is needed for version: $VERSION"
        
        # å¦‚æœæ˜¯å¼ºåˆ¶æ„å»ºï¼Œåˆ™ç›´æ¥è®¾ç½®ä¸ºtrue
        if [ "$FORCE_BUILD" = "true" ]; then
          echo "Force build requested"
          echo "should_build=true" >> $GITHUB_OUTPUT
        else
          # æ£€æŸ¥å½“å‰ä»“åº“æ˜¯å¦å·²å­˜åœ¨å¯¹åº”ç‰ˆæœ¬çš„Release
          EXISTING_RELEASE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/releases/tags/v$VERSION" | jq -r '.tag_name // empty')
          
          if [ -z "$EXISTING_RELEASE" ] || [ "$EXISTING_RELEASE" = "empty" ]; then
            echo "Version $VERSION not found in releases, building..."
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION already exists, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
        fi

  # ä½œä¸š2: æ„å»ºFlatpakåŒ…
  build-flatpak:
    name: Build XTerminal Flatpak
    needs: check-version # ä¾èµ–äº check-version ä½œä¸š
    if: needs.check-version.outputs.should_build == 'true' # ä»…å½“éœ€è¦æ„å»ºæ—¶è¿è¡Œ
    runs-on: ubuntu-latest # è¿è¡Œç¯å¢ƒ
    strategy:
      matrix:
        arch: [x86_64, aarch64] # æ„å»ºçŸ©é˜µï¼Œä¸ºx86_64å’Œaarch64ä¸¤ç§æ¶æ„åˆ†åˆ«æ„å»º
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # æ­¥éª¤2: è®¾ç½®Flatpakç¯å¢ƒ
    - name: Set up Flatpak
      run: |
        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…Flatpakç›¸å…³å·¥å…·
        sudo apt-get update
        sudo apt-get install -y flatpak flatpak-builder qemu-user-static binutils
        
        # æ·»åŠ Flathubè¿œç¨‹ä»“åº“
        sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
        
        # ä¸ºå½“å‰æ¶æ„å®‰è£…Flatpakè¿è¡Œæ—¶å’ŒSDK
        sudo flatpak install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08
        
        # å¦‚æœæ˜¯aarch64æ¶æ„ï¼Œå®‰è£…äº¤å‰ç¼–è¯‘æ‰€éœ€çš„è¿è¡Œæ—¶å’ŒSDK
        if [ "${{ matrix.arch }}" = "aarch64" ]; then
          echo "Installing aarch64 runtime and SDK..."
          sudo flatpak install -y flathub org.freedesktop.Platform/aarch64/24.08 org.freedesktop.Sdk/aarch64/24.08
          sudo flatpak install -y flathub org.freedesktop.Sdk.Extension.toolchain-aarch64//24.08
          
          # å¯ç”¨QEMUè¿›è¡Œaarch64æ¨¡æ‹Ÿ
          sudo systemctl restart systemd-binfmt
          echo "QEMU setup completed for aarch64"
        fi
        
    # æ­¥éª¤3: å‡†å¤‡Flatpakæ¸…å•æ–‡ä»¶
    - name: Prepare Flatpak manifest
      run: |
        # ä»ä¾èµ–ä½œä¸šè·å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION="${{ needs.check-version.outputs.version }}"
        TAG_NAME="${{ needs.check-version.outputs.tag_name }}"
        ARCH="${{ matrix.arch }}"
        CDN_URL="https://cdn-cn.xterminal.cn/downloads/"

        # å°†Flatpakæ¶æ„æ˜ å°„åˆ°XTerminaläºŒè¿›åˆ¶æ–‡ä»¶çš„æ¶æ„åç§°
        case $ARCH in
          "x86_64")
            XTERMINAL_ARCH="amd64"
            ;;
          "aarch64")
            XTERMINAL_ARCH="arm64"
            ;;
        esac
        
        # æ ¹æ®æ¨¡æ¿æ„é€ æ–‡ä»¶åå’Œä¸‹è½½URL
        DEB_FILENAME="XTerminal-${VERSION}-linux-${XTERMINAL_ARCH}.deb"
        DOWNLOAD_URL="${CDN_URL}${DEB_FILENAME}"
        DEB_FILE=$DEB_FILENAME


        echo "=== Version Information ==="
        echo "VERSION: $VERSION"
        echo "Architecture: $ARCH (XTerminal: $XTERMINAL_ARCH)"
        
        # ä¸‹è½½å®˜æ–¹.debåŒ…
        echo "=== Downloading binary from $DOWNLOAD_URL ==="
        if ! wget -O "$DEB_FILE" "$DOWNLOAD_URL"; then
          echo "Error: Failed to download binary for $XTERMINAL_ARCH"
          exit 1
        fi

        # è®¡ç®—tar.gzçš„SHA256å“ˆå¸Œå€¼
        BINARY_SHA256=$(sha256sum "XTerminal-${VERSION}-linux-${XTERMINAL_ARCH}.deb" | awk '{print $1}')
        echo "SHA256: $BINARY_SHA256"
        
        # ä½¿ç”¨sedå‘½ä»¤æ›´æ–°æ¸…å•(YAML)æ–‡ä»¶ä¸­çš„å ä½ç¬¦
        echo "=== Updating Flatpak manifest ==="
        sed  -e "s|BINARY_SHA256|$BINARY_SHA256|g" \
            -e "s|XTERMINAL_ARCH|$XTERMINAL_ARCH|g" \
            -e "s|VERSION|$VERSION|g" \
            com.huancun.xterminal.yaml > "com.huancun.xterminal-$VERSION-$ARCH.yaml"
        
        # æ›´æ–°MetaInfoæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å’Œæ—¥æœŸ
        CURRENT_DATE=$(date +%Y-%m-%d)
        sed -e "s|PLACEHOLDER_VERSION|$VERSION|g" \
            -e "s|PLACEHOLDER_DATE|$CURRENT_DATE|g" \
            com.huancun.xterminal.metainfo.xml > "com.huancun.xterminal-$VERSION.metainfo.xml"
        
        # å¤åˆ¶æ›´æ–°åçš„MetaInfoæ–‡ä»¶
        cp "com.huancun.xterminal-$VERSION.metainfo.xml" com.huancun.xterminal.metainfo.xml
        
        # æ¸…ç†å·²ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶ (flatpak-builderä¼šé‡æ–°ä¸‹è½½)
        rm -f "xterminal-linux-$XTERMINAL_ARCH.tar.gz"
        
        echo "Generated manifest: com.huancun.xterminal-$VERSION-$ARCH.yaml"
        cat "com.huancun.xterminal-$VERSION-$ARCH.yaml"
        
    # æ­¥éª¤4: æ„å»ºFlatpakåŒ…
    - name: Build Flatpak
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        ARCH="${{ matrix.arch }}"
        
        echo "=== Building Flatpak for $ARCH ==="
        
        # ä¸ºaarch64è®¾ç½®äº¤å‰ç¼–è¯‘å‚æ•°
        if [ "$ARCH" = "aarch64" ]; then
          export FLATPAK_BUILDER_ARCH="aarch64"
          BUILD_ARGS="--arch=aarch64"
        else
          BUILD_ARGS=""
        fi
        
        # è¿è¡Œflatpak-builderè¿›è¡Œæ„å»º
        flatpak-builder $BUILD_ARGS --force-clean --repo=repo "build-$ARCH" "com.huancun.xterminal-$VERSION-$ARCH.yaml"
        
        echo "=== Flatpak build completed ==="
        
    # æ­¥éª¤5: å¯¼å‡ºFlatpak bundleæ–‡ä»¶
    - name: Export Flatpak bundle
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        ARCH="${{ matrix.arch }}"
        
        echo "=== Exporting Flatpak bundle ==="
        
        # ä¸ºaarch64è®¾ç½®å¯¼å‡ºå‚æ•°
        if [ "$ARCH" = "aarch64" ]; then
          BUNDLE_ARGS="--arch=aarch64"
        else
          BUNDLE_ARGS=""
        fi
        
        # å¯¼å‡ºä¸º.flatpakæ–‡ä»¶
        flatpak build-bundle $BUNDLE_ARGS repo "com.huancun.xterminal-$VERSION-$ARCH.flatpak" com.huancun.xterminal
        
        echo "Generated bundle: com.huancun.xterminal-$VERSION-$ARCH.flatpak"
        ls -la "com.huancun.xterminal-$VERSION-$ARCH.flatpak"
        
    # æ­¥éª¤6: ä¸Šä¼ Flatpakæ„å»ºäº§ç‰©
    - name: Upload Flatpak artifact
      uses: actions/upload-artifact@v4
      with:
        name: flatpak-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}
        path: com.huancun.xterminal-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}.flatpak
        retention-days: 90 # ä¿ç•™90å¤©
        
    # æ­¥éª¤7: ä¸Šä¼ æ¸…å•æ–‡ä»¶æ„å»ºäº§ç‰©
    - name: Upload manifest artifact
      uses: actions/upload-artifact@v4
      with:
        name: manifest-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}
        path: com.huancun.xterminal-${{ needs.check-version.outputs.version }}-${{ matrix.arch }}.yaml
        retention-days: 90

  # ä½œä¸š3: åˆ›å»ºGitHub Release
  create-release:
    name: Create GitHub Release
    needs: [check-version, build-flatpak] # ä¾èµ–äºcheck-versionå’Œbuild-flatpakä½œä¸š
    if: needs.check-version.outputs.should_build == 'true' # (å·²æ³¨é‡Š)
    runs-on: ubuntu-latest
    
    steps:
    # æ­¥éª¤1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      
    # æ­¥éª¤2: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    # æ­¥éª¤3: åˆ›å»ºGitHub Release
    - name: Create GitHub Release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION="${{ needs.check-version.outputs.version }}"
        TAG_NAME="${{ needs.check-version.outputs.tag_name }}"
        SOURCE_TAG="${{ needs.check-version.outputs.tag_name }}"
        
        # å‡†å¤‡è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
        
        # æ·»åŠ Flatpak bundleså’Œç­¾åæ–‡ä»¶
        for arch in x86_64 aarch64; do
          BUNDLE_FILE="flatpak-$VERSION-$arch/com.huancun.xterminal-$VERSION-$arch.flatpak"
          MANIFEST_FILE="manifest-$VERSION-$arch/com.huancun.xterminal-$VERSION-$arch..yaml"
          
          if [ -f "$BUNDLE_FILE" ]; then
            FILES_TO_UPLOAD="$FILES_TO_UPLOAD $BUNDLE_FILE"
          fi
          
          if [ -f "$MANIFEST_FILE" ]; then
            FILES_TO_UPLOAD="$FILES_TO_UPLOAD $MANIFEST_FILE"
          fi
        done
        
        # ä½¿ç”¨GitHub CLI (gh) åˆ›å»ºRelease
        gh release create "$TAG_NAME" \
          --title "XTerminal Flatpak $VERSION" \
          --notes "## Flatpak Package for XTerminal $VERSION

        This is an automated Flatpak package build from [${{ github.repository }} $SOURCE_TAG](https://github.com/${{ github.repository }}/releases/tag/$SOURCE_TAG).

        ### ğŸ“¦ Package Information
        - **Source**: ${{ github.repository }} $SOURCE_TAG
        - **Package Version**: $VERSION
        - **Build Date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - **Architectures**: x86_64, aarch64
        - **Application ID**: \`com.huancun.xterminal\`
        - **Runtime**: org.freedesktop.Platform 24.08

        " \
          $FILES_TO_UPLOAD

  # ä½œä¸š4: æ¸…ç†
  cleanup:
    name: Cleanup
    needs: [check-version, build-flatpak, create-release] # (å·²æ³¨é‡Š)
    if: always() # æ— è®ºä¹‹å‰çš„ä½œä¸šæ˜¯å¦æˆåŠŸï¼Œæ€»æ˜¯è¿è¡Œ
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup artifacts
      run: |
        echo "Build and release process completed"
        echo "Version: ${{ needs.check-version.outputs.version }}"
        echo "Should build: ${{ needs.check-version.outputs.should_build }}"
